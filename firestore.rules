rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user document (returns null if doesn't exist)
    // Cache the user doc to avoid multiple reads
    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    // Helper function to get user's assigned properties (cached)
    function getUserAssignedProperties() {
      return getUserDoc() != null && 
             getUserDoc().data != null && 
             getUserDoc().data.assignedProperties != null && 
             getUserDoc().data.assignedProperties is list 
             ? getUserDoc().data.assignedProperties 
             : [];
    }
    
    // Helper function to check if property is in user's assigned properties
    function isPropertyAssigned(propertyId) {
      return propertyId in getUserAssignedProperties();
    }
    
    // Helper function to get user role (returns null if user doc doesn't exist)
    function getUserRole() {
      return getUserDoc() != null && getUserDoc().data != null ? getUserDoc().data.role : null;
    }
    
    // Helper function to check if user is admin or super admin
    function isAdmin() {
      return isAuthenticated() && 
             (getUserRole() == 'admin' || getUserRole() == 'super_admin');
    }
    
    // Helper function to check if user is active
    function isUserActive() {
      return isAuthenticated() && 
             getUserDoc() != null && 
             getUserDoc().data != null && 
             getUserDoc().data.isActive == true;
    }
    
    // Helper function to check if user is super admin
    function isSuperAdmin() {
      return isAuthenticated() && getUserRole() == 'super_admin';
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isAuthenticated() && 
                    (request.auth.uid == userId || isAdmin());
      
      // Users can create their own profile during signup
      // This allows:
      // 1. Default signup: role='viewer', isActive=false (self-registration)
      // 2. Invited signup: any role/isActive (when pending invitation exists)
      // Security: Users can only create their OWN profile (userId == auth.uid)
      //           and email must match authenticated user's email
      //           Application code ensures pending invitation exists before using non-default values
      // Note: We allow any role/isActive because invited users need to be able to create profiles
      //       with admin-assigned roles. The application code validates pending invitations exist.
      allow create: if isAuthenticated() && 
                      request.auth.uid == userId &&
                      request.resource.data.email == request.auth.token.email &&
                      request.resource.data.role != null &&
                      request.resource.data.isActive != null &&
                      request.resource.data.email != null;
      
      // Users can update their own profile, but NOT role or isActive
      // Admins can update any user
      allow update: if isAuthenticated() && (
        // User updating their own profile (but not role/isActive)
        (request.auth.uid == userId && 
         request.resource.data.role == resource.data.role &&
         request.resource.data.isActive == resource.data.isActive) ||
        // Admin updating any user
        isAdmin()
      );
      
      // Only admins can create other users' profiles
      allow create: if isAuthenticated() && isAdmin();
      
      // Only super admins can delete users
      allow delete: if isAuthenticated() && getUserRole() == 'super_admin';
    }
    
    // User invitations collection
    match /userInvitations/{invitationId} {
      // Users can read invitations sent to their email
      allow read: if isAuthenticated() && 
                    (resource.data.email == request.auth.token.email || isAdmin());
      
      // Only admins can create/update invitations
      allow create, update: if isAuthenticated() && isAdmin();
      
      // Only admins can delete invitations
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // Pending users collection (for admin-invited users before they sign up)
    match /pendingUsers/{pendingUserId} {
      // Admins can read all pending users
      allow read: if isAuthenticated() && isAdmin();
      
      // Only admins can create pending users
      allow create: if isAuthenticated() && isAdmin();
      
      // System can update when linking to actual user account
      // Users can read their own pending invitation (by email match)
      allow read: if isAuthenticated() && 
                    resource.data.email == request.auth.token.email;
      
      // Only admins can update/delete
      allow update, delete: if isAuthenticated() && isAdmin();
    }
    
    // Properties collection - role-based access
    match /properties/{propertyId} {
      // Super admins have full access, others need proper permissions
      // Maintenance staff can read properties if they have them assigned
      allow read: if isAuthenticated() && isUserActive() && 
                    (isSuperAdmin() || 
                     isAdmin() || 
                     getUserRole() == 'property_manager' ||
                     getUserRole() == 'viewer' ||
                     (getUserRole() == 'maintenance' && isPropertyAssigned(propertyId)));
      
      // Super admins and admins have full write access, property managers can write
      allow write: if isAuthenticated() && isUserActive() && 
                     (isSuperAdmin() || 
                      isAdmin() || 
                      getUserRole() == 'property_manager');
    }
    
    // Buildings collection
    match /buildings/{buildingId} {
      // Users can read if they have access to the building's property
      // Maintenance staff can read buildings for assigned properties
      allow read: if isAuthenticated() && isUserActive() && 
                    (isSuperAdmin() ||
                     isAdmin() || 
                     getUserRole() == 'property_manager' ||
                     getUserRole() == 'viewer' ||
                     (getUserRole() == 'maintenance' && 
                      get(/databases/$(database)/documents/buildings/$(buildingId)).data.propertyId != null &&
                      isPropertyAssigned(get(/databases/$(database)/documents/buildings/$(buildingId)).data.propertyId)));
      
      // Only admins and property managers can write
      allow write: if isAuthenticated() && isUserActive() && 
                     (isSuperAdmin() ||
                      isAdmin() || 
                      getUserRole() == 'property_manager');
    }
    
    // Units collection
    match /units/{unitId} {
      // Users can read if they have access to the unit's property
      // Maintenance staff can read units for assigned properties
      allow read: if isAuthenticated() && isUserActive() && 
                    (isSuperAdmin() ||
                     isAdmin() || 
                     getUserRole() == 'property_manager' ||
                     getUserRole() == 'viewer' ||
                     (getUserRole() == 'maintenance' && 
                      get(/databases/$(database)/documents/units/$(unitId)).data.propertyId != null &&
                      isPropertyAssigned(get(/databases/$(database)/documents/units/$(unitId)).data.propertyId)));
      
      // Only admins and property managers can write
      allow write: if isAuthenticated() && isUserActive() && 
                     (isSuperAdmin() ||
                      isAdmin() || 
                      getUserRole() == 'property_manager');
    }
    
    // Tenants collection
    match /tenants/{tenantId} {
      // Users can read if they're admin OR have access to assigned properties
      // Maintenance staff can read tenants (they need this to create tickets)
      allow read: if isAuthenticated() && isUserActive() && 
                    (isSuperAdmin() ||
                     isAdmin() || 
                     getUserRole() in ['property_manager', 'viewer', 'maintenance']);
      
      // Only admins and property managers can write
      allow write: if isAuthenticated() && isUserActive() && 
                     (isSuperAdmin() ||
                      isAdmin() || 
                      getUserRole() == 'property_manager');
    }
    
    // Leases collection
    match /leases/{leaseId} {
      // Users can read if they're admin OR have access to the lease's property
      // Maintenance staff can read leases for assigned properties
      allow read: if isAuthenticated() && isUserActive() && 
                    (isSuperAdmin() ||
                     isAdmin() || 
                     getUserRole() == 'property_manager' ||
                     getUserRole() == 'viewer' ||
                     (getUserRole() == 'maintenance' && 
                      get(/databases/$(database)/documents/leases/$(leaseId)).data.propertyId != null &&
                      isPropertyAssigned(get(/databases/$(database)/documents/leases/$(leaseId)).data.propertyId)));
      
      // Only admins and property managers can write
      allow write: if isAuthenticated() && isUserActive() && 
                     (isSuperAdmin() ||
                      isAdmin() || 
                      getUserRole() == 'property_manager');
    }
    
    // Maintenance tickets collection
    match /tickets/{ticketId} {
      // Users can read if they're admin OR have access to the ticket's property
      // Maintenance staff can only read tickets for assigned properties
      allow read: if isAuthenticated() && isUserActive() && 
                    (isSuperAdmin() ||
                     isAdmin() || 
                     getUserRole() == 'property_manager' ||
                     getUserRole() == 'viewer' ||
                     (getUserRole() == 'maintenance' && 
                      get(/databases/$(database)/documents/tickets/$(ticketId)).data.propertyId != null &&
                      isPropertyAssigned(get(/databases/$(database)/documents/tickets/$(ticketId)).data.propertyId)));
      
      // Admins, property managers, and maintenance staff can write
      // Property managers and maintenance staff can only write tickets for assigned properties
      allow write: if isAuthenticated() && isUserActive() && 
                     (isSuperAdmin() ||
                      isAdmin() || 
                      (getUserRole() == 'property_manager' && 
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.assignedProperties != null &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.assignedProperties is list &&
                       request.resource.data.propertyId in 
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.assignedProperties) ||
                      (getUserRole() == 'maintenance' && 
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.assignedProperties != null &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.assignedProperties is list &&
                       request.resource.data.propertyId in 
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.assignedProperties));
    }
    
    // Occupancies collection
    match /occupancies/{occupancyId} {
      // Users can read if they have access to the occupancy's property
      // Maintenance staff can read occupancies for assigned properties
      allow read: if isAuthenticated() && isUserActive() && 
                    (isSuperAdmin() ||
                     isAdmin() || 
                     getUserRole() == 'property_manager' ||
                     getUserRole() == 'viewer' ||
                     (getUserRole() == 'maintenance' && 
                      get(/databases/$(database)/documents/occupancies/$(occupancyId)).data.propertyId != null &&
                      isPropertyAssigned(get(/databases/$(database)/documents/occupancies/$(occupancyId)).data.propertyId)));
      
      // Only admins and property managers can write
      allow write: if isAuthenticated() && isUserActive() && 
                     (isSuperAdmin() ||
                      isAdmin() || 
                      getUserRole() == 'property_manager');
    }
    
    // Super admin full access override (must be last, before default deny)
    // Super admins can access any document that doesn't match above rules
    match /{document=**} {
      allow read, write: if isSuperAdmin();
    }
    
    // Default: deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
